<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–ª—É—á–∞–π–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; max-width: 800px; margin: 40px auto; padding: 0 20px; background-color: #f4f4f4; color: #333; }
        .quote-card { background-color: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        blockquote { font-size: 1.5em; margin: 0; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .source { text-align: right; font-style: italic; color: #555; margin-top: 10px; }
        .stats { margin-top: 20px; color: #777; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>
    <div class="quote-card">
        {% if quote %}
            <blockquote>
                ‚Äú{{ quote.text|linebreaks }}‚Äù
            </blockquote>
            <p class="source">‚Äî {{ quote.source.name }}</p>

            <div class="actions">
                <button id="like-btn" data-url="{% url 'quotes:like_quote' quote.id %}">üëç –õ–∞–π–∫</button>
                <button id="dislike-btn" data-url="{% url 'quotes:dislike_quote' quote.id %}">üëé –î–∏–∑–ª–∞–π–∫</button>
            </div>

            <div class="stats">
                <span>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã: {{ quote.views }}</span>
                <span>
                    –õ–∞–π–∫–∏: <span id="likes-count">{{ quote.likes }}</span> / 
                    –î–∏–∑–ª–∞–π–∫–∏: <span id="dislikes-count">{{ quote.dislikes }}</span>
                </span>
            </div>
        {% else %}
            <p>–¶–∏—Ç–∞—Ç—ã –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ –∏—Ö —á–µ—Ä–µ–∑ <a href="/admin/">–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—É—é –ø–∞–Ω–µ–ª—å</a>.</p>
        {% endif %}
    </div>
    
    <a href="{% url 'quotes:top_quotes' %}" style="display: block; text-align: center; margin-top: 20px;">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–æ–ø-10 —Ü–∏—Ç–∞—Ç</a>
    
    {% if quote %}
    <script>
        let isRequestInProgress = false;

        async function handleVote(url) {
            if (isRequestInProgress) {
                return;
            }
            isRequestInProgress = true;

            const csrftoken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json'
                    },
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();

                document.getElementById('likes-count').textContent = data.likes;
                document.getElementById('dislikes-count').textContent = data.dislikes;

                document.getElementById('like-btn').disabled = true;
                document.getElementById('dislike-btn').disabled = true;

            } catch (error) {
                console.error('There has been a problem with your fetch operation:', error);
            } finally {
                isRequestInProgress = false;
            }
        }

        document.getElementById('like-btn').addEventListener('click', () => {
            handleVote(document.getElementById('like-btn').dataset.url);
        });

        document.getElementById('dislike-btn').addEventListener('click', () => {
            handleVote(document.getElementById('dislike-btn').dataset.url);
        });
    </script>
    {% endif %}
</body>
</html>